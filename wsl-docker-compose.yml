# TestAgent WSL 本地 Docker Compose 配置
# 复用已有的 PostgreSQL 和 Redis (均在 client_default 网络)
# Frontend: 39999, Server API: 39998

services:
  # TestAgent Server (Fastify API)
  server:
    build:
      context: .
      dockerfile: k8s/server-Dockerfile
    container_name: testagent-server
    restart: unless-stopped
    ports:
      - "39998:8000"
    environment:
      NODE_ENV: development
      PORT: 8000
      DATABASE_URL: postgresql://mcp_user:mcp_password@postgres:5432/testagent?schema=public
      REDIS_URL: redis://redis:6379
      JWT_SECRET: local-dev-secret-change-in-production
      AGENT_SCRIPT_PATH: /app/agent/coordinator_main.py
      STORAGE_ROOT: /app/storage
      LOG_LEVEL: info
      CORS_ORIGIN: "*"
      WORKSPACE_EXTRA_PATHS: /workspace
      LLM_PROVIDER: ${LLM_PROVIDER:-dashscope}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME:-qwen3-max-preview}
      LLM_API_KEY: ${LLM_API_KEY}
    volumes:
      - uploads_data:/app/uploads
      - /home/zhuangxiaosen/projects/MockProject:/workspace/MockProject:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - testagent-network
      - client_default

  # TestAgent Frontend (Vue + Nginx)
  frontend:
    build:
      context: .
      dockerfile: k8s/frontend-Dockerfile
    container_name: testagent-frontend
    restart: unless-stopped
    ports:
      - "39999:80"
    depends_on:
      server:
        condition: service_healthy
    networks:
      - testagent-network

volumes:
  uploads_data:
    driver: local

networks:
  testagent-network:
    driver: bridge
  # 复用已有的外部网络，连接 PostgreSQL 和 Redis
  client_default:
    external: true
